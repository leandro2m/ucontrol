
<div id="wrapper">
            <div id="header">
                <div class="container"> 

                    <div id="logo">
                        <h2>Pátio Village</a></h2>
                    </div>
                    
                </div>
            </div>
    <div id="page" style="margin-top:40px;margin-left:10px">
         <div class="container">
            <h4>Cisternas</h4>
                    <div class="row">
                    <div class="newcontainer">
                    <div class="sideleft">
                    <div class="cisterna">
                            <div class="6u chart-wrapper">
                            <svg id="fillgauge100" width="50%" height="150" onclick="window.location.href='#/cisternaDash'"></svg>
                            </div>
                            <div class="6u chart-wrapper">
                            <div class="chart-title" style="text-align: center"> Bloco 2 </div>
                            <div class="description">5.000 Litros<br>
                            <span style="color: #333232">Nível 3: 1,40 metro; </span><br>
                            <span style="color: #178BCA">Nível 2: 1 metro; </span><br>
                            <span style="color: #FFCE00">Nível 1:  40 cm; </span><br>
                            <span style="color: #E53A0F"> Nível 0: Vazio </span></div>
                            
                    </div>
        
                    </div>
                    </div>
                    <div class="sideleft">
                    <div class="cisterna">
                            <div class="6u chart-wrapper">
                            <svg id="fillgauge101" wwidth="50%" height="150" onclick="window.location.href='#/'"></svg>
                            </div>
                            <div class="6u chart-wrapper">
                            <div class="eminstalacao" style="text-align: center"> Bloco5 (em breve) </div>
                            <div class="description"> 5.000? Litros<br>
                            <span style="color: #333232">Nível 3: ??? metro;</span><br>
                            <span style="color: #178BCA">Nível 2: ? metro;</span><br>
                            <span style="color: #FFCE00">Nível 1:  ?? cm;</span><br>
                            <span style="color: #E53A0F"> Nível 0: Vazio</span></div>
                            
                    </div>
                    </div>
                    </div>
                    </div>
                    </div>
                    <br>

                    <h4>Caixas d'águas dos blocos</h4>
                    <br>
                    <div class="row">
                
                    <div class="cisterna">
                            <div class="6u chart-wrapper">
                            <svg id="fillgauge1" wwidth="50%" height="150" onclick="window.location.href='#/'"></svg>
                            </div>
                            <div class="6u chart-wrapper">
                            <div class="eminstalacao" style="text-align: center"> Bloco 1 (em breve) </div>
                            <div class="description">9.000? Litros<br>
                            <span style="color: #333232">Nível 3: ?? metro;</span><br>
                            <span style="color: #178BCA">Nível 2: ? metro;</span><br>
                            <span style="color: #FFCE00">Nível 1:  ?? cm;</span><br>
                            <span style="color: #E53A0F"> Nível 0: Vazio </span><br>
                            
                    </div>

                    </div>
                    <br>
                    
                    <div class="cisterna">
                            <div class="6u chart-wrapper">
                            <svg id="fillgauge2" width="50%" height="150" onclick="window.location.href='#/'"></svg>
                            </div>
                            <div class="6u chart-wrapper">
                            <div class="eminstalacao" style="text-align: center"> Bloco 2 (em breve) </div>
                            <div class="description"> 9.000? Litros<br>
                            <span style="color: #333232">Nível 3: ??? metro;</span><br> 
                            <span style="color: #178BCA">Nível 2: ? metro;</span><br>
                            <span style="color: #FFCE00">Nível 1:  ?? cm;</span><br>
                            <span style="color: #E53A0F"> Nível 0: Vazio</span></div>
                            
                    </div>
                    </div>
                    <br>
                    <div class="cisterna">
                            <div class="6u chart-wrapper">
                            <svg id="fillgauge3" width="50%" height="150" onclick="window.location.href='#/caixaDash3A'"></svg>
                            </div>
                            <div class="6u chart-wrapper">
                            <div class="chart-title" style="text-align: center"> Bloco 3 </div>
                            <div class="description"> 9.000 Litros<br>
                            <span style="color: #333232">Nível 3: 1.63 metro;</span><br>
                            <span style="color: #178BCA">Nível 2: 1.40 metro;</span><br>
                            <span style="color: #FFCE00">Nível 1: 60 cm;</span><br>
                            <span style="color: #E53A0F"> Nível 0: Vazio</span></div>
                            
                    </div>
                    </div>


                    </div>
                    <br>

                    <div class="row">
                    <div class="newcontainer">
                    <div class="sideleft">
                    <div class="cisterna">
                            <div class="6u chart-wrapper">
                            <svg id="fillgauge4a" width="75%" height="200" onclick="window.location.href='#/cisternaDash'"></svg>
                            </div>
                            <div class="6u chart-wrapper">
                            <div class="eminstalacao" style="text-align: center"> Bloco 4A (em breve) </div>
                            <div class="description">???? Litros<br>
                            <span style="color: #333232">Nível 3: ?? metro;</span><br> 
                            <span style="color: #178BCA">Nível 2: ? metro;</span><br>
                            <span style="color: #FFCE00">Nível 1:  ?? cm;</span><br>
                            <span style="color: #E53A0F"> Nível 0: Vazio</span></div>
                            
                    </div>
        
                    </div>
                    </div>
                    <div class="sideleft">
                    <div class="cisterna">
                            <div class="6u chart-wrapper">
                            <svg id="fillgauge4b" width="75%" height="200" onclick="window.location.href='#/'"></svg>
                            </div>
                            <div class="6u chart-wrapper">
                            <div class="eminstalacao" style="text-align: center"> Bloco 4B (em breve) </div>
                            <div class="description">????? Litros<br>
                            <span style="color: #333232">Nível 3: ??? metro;</span><br> 
                            <span style="color: #178BCA">Nível 2: ? metro; </span><br>
                            <span style="color: #FFCE00">Nível 1:  ?? cm; </span><br>
                            <span style="color: #E53A0F"> Nível 0: Vazio </span></div>
                            
                    </div>
                    </div>
                    </div>
                    </div>
                    </div>
                    <br>

                    <div class="row">
                    <div class="newcontainer">
                    <div class="sideleft">
                    <div class="cisterna">
                            <div class="6u chart-wrapper">
                            <svg id="fillgauge5a" width="75%" height="200" onclick="window.location.href='#/caixaDash5A'"></svg>
                            </div>
                            <div class="6u chart-wrapper">
                            <div class="chart-title" style="text-align: center"> Bloco 5A </div>
                            <div class="description">???? Litros<br>
                            <span style="color: #333232">Nível 3: ?? metro;</span><br>
                            <span style="color: #178BCA">Nível 2: ? metro;</span><br>
                            <span style="color: #FFCE00">Nível 1:  ?? cm;</span><br>
                            <span style="color: #E53A0F"> Nível 0: Vazio</span></div>
                            
                    </div>
        
                    </div>
                    </div>
                    <div class="sideleft">
                    <div class="cisterna">
                            <div class="6u chart-wrapper">
                            <svg id="fillgauge5b" width="75%" height="200" onclick="window.location.href='#/'"></svg>
                            </div>
                            <div class="6u chart-wrapper">
                            <div class="eminstalacao" style="text-align: center"> Bloco 5B (em breve) </div>
                            <div class="description"> 3.000 Litros<br>
                            <span style="color: #333232">Nível 3: ??? metro;</span><br>
                            <span style="color: #178BCA">Nível 2: ? metro;</span><br>
                            <span style="color: #FFCE00">Nível 1:  ?? cm;</span><br>
                            <span style="color: #E53A0F"> Nível 0: Vazio</span></div>
                            
                    </div>
                    </div>
                    </div>
                    </div>
                    </div>
                    <br>

                    <div class="row">
                    <div class="newcontainer">
                    <div class="sideleft">
                    <div class="cisterna">
                            <div class="6u chart-wrapper">
                            <svg id="fillgauge6a" width="75%" height="200" onclick="window.location.href='#/'"></svg>
                            </div>
                            <div class="6u chart-wrapper">
                            <div class="eminstalacao" style="text-align: center"> Bloco 6A (em breve) </div>
                            <div class="description"> 3.000 Litros<br>
                            <span style="color: #333232;" >Nível 3: ?? metro;</span><br>
                            <span style="color: #178BCA">Nível 2: ? metro;</span><br>
                            <span style="color: #FFCE00">Nível 1:  ?? cm;</span><br>
                            <span style="color: #E53A0F"> Nível 0: Vazio</span></div>
                            
                    </div>
        
                    </div>
                    </div>
                    <div class="sideleft">
                    <div class="cisterna">
                            <div class="6u chart-wrapper">
                            <svg id="fillgauge6b" width="75%" height="200" onclick="window.location.href='#/'"></svg>
                            </div>
                            <div class="6u chart-wrapper">
                            <div class="eminstalacao" style="text-align: center"> Bloco6B (em breve) </div>
                            <div class="description"> 3.000 Litros<br>
                            <span style="color: #333232">Nível 3: ??? metro; </span><br> 
                            <span style="color: #178BCA">Nível 2: ? metro; </span><br>
                            <span style="color: #FFCE00">Nível 1:  ?? cm; </span><br>
                            <span style="color: #E53A0F"> Nível 0: Vazio </span></div>
                            
                    </div>
                    </div>
                    </div>
                    </div>
                    </div>                      
            </div>
            
        </div>  
    </div>

<script language="JavaScript">
  
queue()
   .defer(d3.json, "/api/data/1/latest")
   .await(displayTotals);
   
var ci3Min = setInterval(renderT, 180000);
function renderT() {
   queue().defer(d3.json, "/api/data/1/latest").await(displayTotals);
}	

   function displayTotals(error, apiData){
   //Start Transformations
	var dataSet = apiData;
	var dateFormat = d3.time.format("%m/%d/%Y %H:%M:%S");
	
	dataSet.forEach(function(d) {
		d.datetime = dateFormat.parse(d.datetime);
//		console.log(d.datetime);
		if (d.level4 == 1) {
			d.total = 4;
            d.changecolor = "#E53A0F"
			} 
		else if (d.level3 == 1) {
			d.total = 3;
            d.changecolor = "#333232"
			}
		else if (d.level2 == 1) {
			d.total = 2;
            d.changecolor = "#178BCA"
			}
		else if (d.level1 == 1) {
			d.total = 1;
            d.changecolor = "#FFCE00"
			}	
		 else {
			d.total = 0;
            d.changecolor = "#E53A0F"
		   }	
	});
 
 //Cria Crossfilter
	var ndx = crossfilter(dataSet);
	
    // Cria as dimensões
	var timeDim = ndx.dimension(function(d) {return new Date(d.datetime).getTime() });
 

// Cisterna Bloco 2 
		var tdlen= timeDim.top(Number.POSITIVE_INFINITY).length;

		var a = 0;
		while (a < tdlen)
         {
            if ( timeDim.top(tdlen)[a].sensorid == "UCSCistern1" && timeDim.top(tdlen)[a].blocoid == 2){
			   var lastVolume100 = timeDim.top(tdlen)[a].total;
               var changecolor100 = timeDim.top(tdlen)[a].changecolor	
			   break; // breaks out of loop completely
            }
            a = a + 1;
         }

         //bloco 2 caixa d'agua 
         var b = 0;
        while (b < tdlen)
         {
            if ( timeDim.top(tdlen)[b].sensorid == "UCSReserv1" && timeDim.top(tdlen)[b].blocoid == 2){
               var lastVolume2 = timeDim.top(tdlen)[b].total;
               var changecolor2 = timeDim.top(tdlen)[b].changecolor     
               break; // breaks out of loop completely
            }
            b = b + 1;
         }
         //bloco 3 caixa d'agua 
           var c = 0;
        while (c < tdlen)
         {
            if ( timeDim.top(tdlen)[c].sensorid == "UCSReserv1" && timeDim.top(tdlen)[c].blocoid == 3){
               var lastVolume3 = timeDim.top(tdlen)[c].total;
               var changecolor3 = timeDim.top(tdlen)[c].changecolor     
               break; // breaks out of loop completely
            }
            c = c + 1;
         }

         //bloco 5 caixa d'agua 
         var e = 0;
        while (e < tdlen)
         {
            if ( timeDim.top(tdlen)[e].sensorid == "UCSReserv1" && timeDim.top(tdlen)[e].blocoid == 5){
               var lastVolume5 = timeDim.top(tdlen)[e].total;
               var changecolor5 = timeDim.top(tdlen)[e].changecolor     
               break; // breaks out of loop completely
            }
            e = e + 1;
         }


// Configura gaugue

    var config1 = liquidFillGaugeDefaultSettings();
    config1.circleThickness = 0.2;
    config1.waveAnimateTime = 2000;
    config1.waveAnimate = true;
	config1.waveCount = 2;
    config1.waveOffset = 0.25;
    config1.textSize = 1.2;
    config1.minValue = 0;
    config1.maxValue = 3;
    config1.waveHeight = 0.15;


//Cisternas
	 var gauge100 = loadLiquidFillGauge("fillgauge100", lastVolume100, config1, changecolor100); //cisterna bloco 2
     var gauge101 = loadLiquidFillGauge("fillgauge101", 0, config1, "#E53A0F"); //cisterna bloco 5
//Caixas D agua dos Blocos
     var gauge1 = loadLiquidFillGauge("fillgauge1", 0, config1, "#E53A0F"); //caixa d agua bloco 3
     var gauge2 = loadLiquidFillGauge("fillgauge2", 0, config1, "#E53A0F"); //caixa d agua bloco 3
     var gauge3 = loadLiquidFillGauge("fillgauge3", lastVolume3, config1, changecolor3); //caixa d agua bloco 3
     var gauge4a = loadLiquidFillGauge("fillgauge4a", 0, config1, "#E53A0F"); //caixa d agua bloco 4A
     var gauge4b = loadLiquidFillGauge("fillgauge4b", 0, config1, "#E53A0F"); // caixa d agua bloco 4B
     var gauge5a = loadLiquidFillGauge("fillgauge5a", lastVolume5, config1, changecolor5); // caixa d agua bloco 5A
     var gauge5b = loadLiquidFillGauge("fillgauge5b", 0, config1, "#E53A0F"); //caixa d agua bloco 5B
     var gauge6a = loadLiquidFillGauge("fillgauge6a", 0, config1, "#E53A0F"); // caixa d agua bloco 6A
     var gauge6b = loadLiquidFillGauge("fillgauge6b", 0, config1, "#E53A0F"); //caixa d agua bloco 6B
     
     
	
};
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////	
	
function liquidFillGaugeDefaultSettings(){
    return {
        minValue: 0, // The gauge minimum value.
        maxValue: 3, // The gauge maximum value.
        circleThickness: 0.05, // The outer circle thickness as a percentage of it's radius.
        circleFillGap: 0.05, // The size of the gap between the outer circle and wave circle as a percentage of the outer circles radius.
        circleColor: "#178BCA", // The color of the outer circle.
        waveHeight: 0.05, // The wave height as a percentage of the radius of the wave circle.
        waveCount: 1, // The number of full waves per width of the wave circle.
        waveRiseTime: 1000, // The amount of time in milliseconds for the wave to rise from 0 to it's final height.
        waveAnimateTime: 18000, // The amount of time in milliseconds for a full wave to enter the wave circle.
        waveRise: true, // Control if the wave should rise from 0 to it's full height, or start at it's full height.
        waveHeightScaling: true, // Controls wave size scaling at low and high fill percentages. When true, wave height reaches it's maximum at 50% fill, and minimum at 0% and 100% fill. This helps to prevent the wave from making the wave circle from appear totally full or empty when near it's minimum or maximum fill.
        waveAnimate: true, // Controls if the wave scrolls or is static.
        waveColor: "#178BCA", // The color of the fill wave.
        waveOffset: 0, // The amount to initially offset the wave. 0 = no offset. 1 = offset of one full wave.
        textVertPosition: .5, // The height at which to display the percentage text withing the wave circle. 0 = bottom, 1 = top.
        textSize: 1, // The relative height of the text to display in the wave circle. 1 = 50%
        valueCountUp: true, // If true, the displayed value counts up from 0 to it's final value upon loading. If false, the final value is displayed.
        displayPercent: false, // If true, a % symbol is displayed after the value.
        textColor: "#045681", // The color of the value text when the wave does not overlap it.
        waveTextColor: "#A4DBf8" // The color of the value text when the wave overlaps it.
    };
}

function loadLiquidFillGauge(elementId, value, config, updatecolor) {
    if(config == null) config = liquidFillGaugeDefaultSettings();

    var gauge = d3.select("#" + elementId);
    var radius = Math.min(parseInt(gauge.style("width")), parseInt(gauge.style("height")))/2;
    var locationX = parseInt(gauge.style("width"))/2 - radius;
    var locationY = parseInt(gauge.style("height"))/2 - radius;
    var fillPercent = Math.max(config.minValue, Math.min(config.maxValue, value))/config.maxValue;

    var waveHeightScale;
    if(config.waveHeightScaling){
        waveHeightScale = d3.scale.linear()
            .range([0,config.waveHeight,0])
            .domain([0,50,100]);
    } else {
        waveHeightScale = d3.scale.linear()
            .range([config.waveHeight,config.waveHeight])
            .domain([0,100]);
    }

    var textPixels = (config.textSize*radius/2);
    var textFinalValue = parseFloat(value).toFixed(2);
    var textStartValue = config.valueCountUp?config.minValue:textFinalValue;
    var percentText = config.displayPercent?"%":"";
    var circleThickness = config.circleThickness * radius;
    var circleFillGap = config.circleFillGap * radius;
    var fillCircleMargin = circleThickness + circleFillGap;
    var fillCircleRadius = radius - fillCircleMargin;
    var waveHeight = fillCircleRadius*waveHeightScale(fillPercent*100);

    var waveLength = fillCircleRadius*2/config.waveCount;
    var waveClipCount = 1+config.waveCount;
    var waveClipWidth = waveLength*waveClipCount;

    // Rounding functions so that the correct number of decimal places is always displayed as the value counts up.
    var textRounder = function(value){ return Math.round(value); };
    if(parseFloat(textFinalValue) != parseFloat(textRounder(textFinalValue))){
        textRounder = function(value){ return parseFloat(value).toFixed(1); };
    }
    if(parseFloat(textFinalValue) != parseFloat(textRounder(textFinalValue))){
        textRounder = function(value){ return parseFloat(value).toFixed(2); };
    }

    // Data for building the clip wave area.
    var data = [];
    for(var i = 0; i <= 40*waveClipCount; i++){
        data.push({x: i/(40*waveClipCount), y: (i/(40))});
    }

    // Scales for drawing the outer circle.
    var gaugeCircleX = d3.scale.linear().range([0,2*Math.PI]).domain([0,1]);
    var gaugeCircleY = d3.scale.linear().range([0,radius]).domain([0,radius]);

    // Scales for controlling the size of the clipping path.
    var waveScaleX = d3.scale.linear().range([0,waveClipWidth]).domain([0,1]);
    var waveScaleY = d3.scale.linear().range([0,waveHeight]).domain([0,1]);

    // Scales for controlling the position of the clipping path.
    var waveRiseScale = d3.scale.linear()
        // The clipping area size is the height of the fill circle + the wave height, so we position the clip wave
        // such that the it will overlap the fill circle at all when at 0%, and will totally cover the fill
        // circle at 100%.
        .range([(fillCircleMargin+fillCircleRadius*2+waveHeight),(fillCircleMargin-waveHeight)])
        .domain([0,1]);
    var waveAnimateScale = d3.scale.linear()
        .range([0, waveClipWidth-fillCircleRadius*2]) // Push the clip area one full wave then snap back.
        .domain([0,1]);

    // Scale for controlling the position of the text within the gauge.
    var textRiseScaleY = d3.scale.linear()
        .range([fillCircleMargin+fillCircleRadius*2,(fillCircleMargin+textPixels*0.7)])
        .domain([0,1]);

    // Center the gauge within the parent SVG.
    var gaugeGroup = gauge.append("g")
        .attr('transform','translate('+locationX+','+locationY+')');

    // Draw the outer circle.
    var gaugeCircleArc = d3.svg.arc()
        .startAngle(gaugeCircleX(0))
        .endAngle(gaugeCircleX(1))
        .outerRadius(gaugeCircleY(radius))
        .innerRadius(gaugeCircleY(radius-circleThickness));
    gaugeGroup.append("path")
        .attr("d", gaugeCircleArc)
        .style("fill", updatecolor)
        .attr('transform','translate('+radius+','+radius+')');

    // Text where the wave does not overlap.
    var text1 = gaugeGroup.append("text")
        .text(textRounder(textStartValue) + percentText)
        .attr("class", "liquidFillGaugeText")
        .attr("text-anchor", "middle")
        .attr("font-size", textPixels + "px")
        .style("fill", config.textColor)
        .attr('transform','translate('+radius+','+textRiseScaleY(config.textVertPosition)+')');

    // The clipping wave area.
    var clipArea = d3.svg.area()
        .x(function(d) { return waveScaleX(d.x); } )
        .y0(function(d) { return waveScaleY(Math.sin(Math.PI*2*config.waveOffset*-1 + Math.PI*2*(1-config.waveCount) + d.y*2*Math.PI));} )
        .y1(function(d) { return (fillCircleRadius*2 + waveHeight); } );
    var waveGroup = gaugeGroup.append("defs")
        .append("clipPath")
        .attr("id", "clipWave" + elementId);
    var wave = waveGroup.append("path")
        .datum(data)
        .attr("d", clipArea)
        .attr("T", 0);

    // The inner circle with the clipping wave attached.
    var fillCircleGroup = gaugeGroup.append("g")
        .attr("clip-path", "url(#clipWave" + elementId + ")");
    fillCircleGroup.append("circle")
        .attr("cx", radius)
        .attr("cy", radius)
        .attr("r", fillCircleRadius)
        .style("fill", updatecolor);

    // Text where the wave does overlap.
    var text2 = fillCircleGroup.append("text")
        .text(textRounder(textStartValue) + percentText)
        .attr("class", "liquidFillGaugeText")
        .attr("text-anchor", "middle")
        .attr("font-size", textPixels + "px")
        .style("fill", config.waveTextColor)
        .attr('transform','translate('+radius+','+textRiseScaleY(config.textVertPosition)+')');

    // Make the value count up.
    if(config.valueCountUp){
        var textTween = function(){
            var i = d3.interpolate(this.textContent, textFinalValue);
            return function(t) { this.textContent = textRounder(i(t)) + percentText; }
        };
        text1.transition()
            .duration(config.waveRiseTime)
            .tween("text", textTween);
        text2.transition()
            .duration(config.waveRiseTime)
            .tween("text", textTween);
    }

    // Make the wave rise. wave and waveGroup are separate so that horizontal and vertical movement can be controlled independently.
    var waveGroupXPosition = fillCircleMargin+fillCircleRadius*2-waveClipWidth;
    if(config.waveRise){
        waveGroup.attr('transform','translate('+waveGroupXPosition+','+waveRiseScale(0)+')')
            .transition()
            .duration(config.waveRiseTime)
            .attr('transform','translate('+waveGroupXPosition+','+waveRiseScale(fillPercent)+')')
            .each("start", function(){ wave.attr('transform','translate(1,0)'); }); // This transform is necessary to get the clip wave positioned correctly when waveRise=true and waveAnimate=false. The wave will not position correctly without this, but it's not clear why this is actually necessary.
    } else {
        waveGroup.attr('transform','translate('+waveGroupXPosition+','+waveRiseScale(fillPercent)+')');
    }

    if(config.waveAnimate) animateWave();

    function animateWave() {
        wave.attr('transform','translate('+waveAnimateScale(wave.attr('T'))+',0)');
        wave.transition()
            .duration(config.waveAnimateTime * (1-wave.attr('T')))
            .ease('linear')
            .attr('transform','translate('+waveAnimateScale(1)+',0)')
            .attr('T', 1)
            .each('end', function(){
                wave.attr('T', 0);
                animateWave(config.waveAnimateTime);
            });
    }

    function GaugeUpdater(){
        this.update = function(value){
            var newFinalValue = parseFloat(value).toFixed(2);
            var textRounderUpdater = function(value){ return Math.round(value); };
            if(parseFloat(newFinalValue) != parseFloat(textRounderUpdater(newFinalValue))){
                textRounderUpdater = function(value){ return parseFloat(value).toFixed(1); };
            }
            if(parseFloat(newFinalValue) != parseFloat(textRounderUpdater(newFinalValue))){
                textRounderUpdater = function(value){ return parseFloat(value).toFixed(2); };
            }

            var textTween = function(){
                var i = d3.interpolate(this.textContent, parseFloat(value).toFixed(2));
                return function(t) { this.textContent = textRounderUpdater(i(t)) + percentText; }
            };

            text1.transition()
                .duration(config.waveRiseTime)
                .tween("text", textTween);
            text2.transition()
                .duration(config.waveRiseTime)
                .tween("text", textTween);

            var fillPercent = Math.max(config.minValue, Math.min(config.maxValue, value))/config.maxValue;
            var waveHeight = fillCircleRadius*waveHeightScale(fillPercent*100);
            var waveRiseScale = d3.scale.linear()
                // The clipping area size is the height of the fill circle + the wave height, so we position the clip wave
                // such that the it will overlap the fill circle at all when at 0%, and will totally cover the fill
                // circle at 100%.
                .range([(fillCircleMargin+fillCircleRadius*2+waveHeight),(fillCircleMargin-waveHeight)])
                .domain([0,1]);
            var newHeight = waveRiseScale(fillPercent);
            var waveScaleX = d3.scale.linear().range([0,waveClipWidth]).domain([0,1]);
            var waveScaleY = d3.scale.linear().range([0,waveHeight]).domain([0,1]);
            var newClipArea;
            if(config.waveHeightScaling){
                newClipArea = d3.svg.area()
                    .x(function(d) { return waveScaleX(d.x); } )
                    .y0(function(d) { return waveScaleY(Math.sin(Math.PI*2*config.waveOffset*-1 + Math.PI*2*(1-config.waveCount) + d.y*2*Math.PI));} )
                    .y1(function(d) { return (fillCircleRadius*2 + waveHeight); } );
            } else {
                newClipArea = clipArea;
            }

            var newWavePosition = config.waveAnimate?waveAnimateScale(1):0;
            wave.transition()
                .duration(0)
                .transition()
                .duration(config.waveAnimate?(config.waveAnimateTime * (1-wave.attr('T'))):(config.waveRiseTime))
                .ease('linear')
                .attr('d', newClipArea)
                .attr('transform','translate('+newWavePosition+',0)')
                .attr('T','1')
                .each("end", function(){
                    if(config.waveAnimate){
                        wave.attr('transform','translate('+waveAnimateScale(0)+',0)');
                        animateWave(config.waveAnimateTime);
                    }
                });
            waveGroup.transition()
                .duration(config.waveRiseTime)
                .attr('transform','translate('+waveGroupXPosition+','+newHeight+')')
        }
    }

    return new GaugeUpdater();
}
	
	
</script>